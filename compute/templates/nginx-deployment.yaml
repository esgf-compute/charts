{{- if .Values.nginx.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ template "compute.nginx.fullname" . }}
  labels:
  {{- include "compute.nginx.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.nginx.replicas }}
  selector:
    matchLabels:
    {{- include "compute.nginx.matchLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
      {{- include "compute.nginx.matchLabels" . | nindent 8 }}
    spec:
      {{- if .Values.nginx.nodeSelector }}
      nodeSelector: 
      {{ .Values.nginx.nodeSelector | toYaml | nindent 8 }}
      {{- end }}
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets:
      {{ .Values.imagePullSecrets | toYaml | nindent 8 }}
      {{- end }}
      initContainers:
      - name: collect-django-static
        image: {{ .Values.wps.image }}:{{ .Values.wps.imageTag }}
        imagePullPolicy: {{ .Values.nginx.imagePullPolicy }}
        resources:
        {{ .Values.nginx.resources | toYaml | nindent 10 }}
        env:
        - name: SECRET_KEY
          value: "SECRET_KEY"
        args: ['/bin/bash', '-c', 'mkdir -p /compute/assets && python /compute/manage.py collectstatic --no-input']
        volumeMounts:
        - mountPath: /var/www/static
          name: static-volume
      - name: collect-app-static
        image: {{ .Values.nginx.image }}:{{ .Values.nginx.imageTag }}
        imagePullPolicy: {{ .Values.nginx.imagePullPolicy }}
        resources:
        {{ .Values.nginx.resources | toYaml | nindent 10 }}
        args: ['/bin/bash', '-c', 'cp -rf /usr/share/nginx/html/static/* /compute/assets']
        volumeMounts:
        - mountPath: /compute/assets
          name: static-volume
      containers:
      - name: nginx
        image: {{ .Values.nginx.image }}:{{ .Values.nginx.imageTag }}
        imagePullPolicy: {{ .Values.nginx.imagePullPolicy }}
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 3
          periodSeconds: 3
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 3
          periodSeconds: 3
        resources: 
        {{ .Values.nginx.resources | toYaml | nindent 10 }}
        volumeMounts:
        - mountPath: /usr/share/nginx/html/static
          name: static-volume
      volumes:
      - name: static-volume
        emptyDir: {}
{{- end }}
